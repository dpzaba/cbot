#!/usr/bin/env ruby

class KarmaListener
  def listen(msg)
    msg.scan(/@(\w+)\+\+/) do |match|
      redis.incr redis_key_for match.first
    end
  end

  def karma_for(nickname)
    nickname = nickname[1, -1] if nickname.start_with?("@")
    redis.get(redis_key_for nickname).to_i
  end

  private

  def redis_key_for(nickname)
    ["cbot", "karma", nickname.downcase].join ":"
  end

  def redis
    @redis ||= begin
                 require 'redis'
                 Redis.new
               end
  end
end

kl = KarmaListener.new

command, *rest = ARGV
case command
when "for"
  puts rest.map { |s| "    karma for #{s}: #{kl.karma_for s}" }
when "listen"
  kl.listen rest.join(" ")
else
  puts "¯\\_(ツ)_/¯"
end
